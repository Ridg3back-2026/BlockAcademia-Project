<!doctype html>
<html lang="en">
<!-- Please note that this page and Javascript was developed with the Assistance of Gemini AI model using the repositories shared during class excerise for weeks 3-5 (https://pastebin.com/2f70amw1, https://pastebin.com/2f70amw1, https://pastebin.com/EtzJ8pFk and https://pastebin.com/EpK3xcMK); where the prompts used are as follows:
 1. "I need to build a new client to interface with the web for my project given the following files. I have an existing file can you refactor so that it simulates the results in the test cases"-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Verify Credential | BlockAcademia</title>

    <link rel="stylesheet" href="/static/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/vendor/font-awesome/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/custom.css">

</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a href="/" class="navbar-brand">BlockAcademia</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a href="/" class="nav-link">Home</a>
                    </li>
                    <li class="nav-item">
                        <a href="/issue/credential" class="nav-link">Issue Credential</a>
                    </li>
                    <li class="nav-item active">
                        <a href="/verify/credential" class="nav-link">Verify Credential</a>
                    </li>
<!--                     <li class="nav-item">
                        <a href="/configure" class="nav-link">Configure Node</a>
                    </li> -->
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="mt-5">Verify Credential on Blockchain</h1>
            </div>
        </div>
        <hr>
        
        <div class="row mb-4">
            <div class="col-lg-12">
                <h2>1. Wallet Tool</h2>
                <p>Use this tool to generate a new Public Key (Wallet) or retrieve the hardcoded test user's key.</p>
                <button type="button" class="btn btn-secondary" id="generate_wallet_button">Generate New Wallet</button>
                <button type="button" class="btn btn-info" id="test_key_button">Load Test Key</button>

                <div class="mt-3">
                    <label for="student_public_key">Your Public Key (Wallet Address):</label>
                    <textarea class="form-control" id="student_public_key" name="recipient_public_key" rows="2" readonly>{{ test_public_key }}</textarea>
                </div>
            </div>
        </div>

        <hr>

        <div class="row">
            <div class="col-lg-12">
                <h2>2. Enter Credential Details for Verification</h2>
                <p>The **Credential Hash** is the digital fingerprint of your official certificate/diploma.</p>
                <form id="verify_credential_form">
                    <div class="form-group">
                        <label for="recipient_public_key">Wallet Address (Recipient Public Key)</label>
                        <textarea class="form-control" id="recipient_public_key" name="recipient_public_key" rows="2" required></textarea>
                        <small class="form-text text-muted">Must match the key the credential was issued to.</small>
                    </div>
                    <div class="form-group">
                        <label for="credential_hash_input">Credential Hash (SHA256)</label>
                        <textarea class="form-control" id="credential_hash_input" name="credential_hash" rows="2" required placeholder="Paste the SHA256 hash of the credential here..."></textarea>
                        <small class="form-text text-muted">This hash is unique to your credential's content and recipient.</small>
                    </div>
                    
                    <button type="button" class="btn btn-primary" id="verify_button">Verify Credential on Blockchain</button>
                </form>
                
                <h3 class="mt-5">Verification Result</h3>
                <div id="verification_result">
                    <div class="alert alert-success d-none" role="alert" id="valid_alert">
                        <strong><i class="fa fa-check-circle"></i> VALID CREDENTIAL FOUND!</strong>
                        <p class="mb-1">Credential verified successfully on the public blockchain. This confirms authenticity and integrity.</p>
                        <hr>
                        <p class="mb-0"><strong>Issuer:</strong> <span id="issuer_output"></span></p>
                        <p class="mb-0"><strong>Credential Type:</strong> <span id="credential_type_output"></span></p>
                        <p class="mb-0"><strong>Issue Date:</strong> <span id="issue_date_output"></span></p>
                        <p class="mb-0"><strong>Transaction ID:</strong> <code id="transaction_id_output"></code></p>
                    </div>
                    <div class="alert alert-danger d-none" role="alert" id="invalid_alert">
                        <strong><i class="fa fa-times-circle"></i> INVALID CREDENTIAL</strong>
                        <p id="invalid_message"></p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="/static/vendor/jquery/jquery.min.js"></script>
    <script src="/static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <script>
        $(function() {
            // Set initial value for verification form using the test key
            const initialTestKey = $('#student_public_key').val();
            $('#recipient_public_key').val(initialTestKey);
            
            // Auto-load the MITS AI test credential hash for the test key
            // This is the hash for the hardcoded "MITS AI" credential issued to TEST_USER_PUBLIC_KEY
            const testCredentialHash = "c93d987d97b91d2d3a379477e6d77363403a45c614524c5750d4f54e19195b46";
            $('#credential_hash_input').val(testCredentialHash);

            // Button to load test key
            $('#test_key_button').click(function() {
                $('#student_public_key').val(initialTestKey);
                $('#recipient_public_key').val(initialTestKey);
                $('#credential_hash_input').val(testCredentialHash);
            });

            // Wallet Generation
            $('#generate_wallet_button').click(function() {
                $.ajax({
                    url: '/wallet/new',
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        $('#student_public_key').val(response.public_key);
                        $('#recipient_public_key').val(response.public_key);
                        $('#credential_hash_input').val(''); // Clear hash for a new user
                        alert("New wallet generated. Public key copied to the form fields. You must now issue a credential to this new key.");
                    },
                    error: function(error) {
                        console.log("Error generating wallet:", error);
                        alert("Could not generate wallet. Check console for details.");
                    }
                });
            });


            $('#verify_button').click(function() {
                // Clear previous results
                $('#valid_alert').addClass('d-none');
                $('#invalid_alert').addClass('d-none');

                let recipient_key = $('#recipient_public_key').val();
                let credential_hash = $('#credential_hash_input').val();
                
                if (!recipient_key || !credential_hash) {
                    $('#invalid_message').text("Please provide both the Wallet Address (Public Key) and the Credential Hash.");
                    $('#invalid_alert').removeClass('d-none');
                    return;
                }

                let payload = {
                    recipient_public_key: recipient_key,
                    credential_hash: credential_hash
                };
                
                // Assuming the central blockchain node is at 127.0.0.1:5000 (from client.py)
                //let centralNodeAddress = "http://127.0.0.1:5000";
                let centralNodeAddress = "http://127.0.0.1:5001";  
                
                $.ajax({
                    url: centralNodeAddress + '/credentials/verify',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    
                    success: function(response) {
                        if (response.is_valid) {
                            $('#issuer_output').text(response.issuer);
                            $('#credential_type_output').text(response.credential_type);
                            $('#issue_date_output').text(response.issue_date);
                            $('#transaction_id_output').text(response.transaction_id);
                            
                            $('#valid_alert').removeClass('d-none');
                        } else {
                            // Invalid, but not an error status code (e.g., credential not found)
                            $('#invalid_message').text(response.message);
                            $('#invalid_alert').removeClass('d-none');
                        }
                    },
                    error: function(jqXHR) {
                        let errorMessage = jqXHR.responseJSON && jqXHR.responseJSON.message ? jqXHR.responseJSON.message : jqXHR.statusText;
                        
                        $('#invalid_message').text(`API Error (${jqXHR.status}): ${errorMessage}`);
                        $('#invalid_alert').removeClass('d-none');
                        console.log("Error verifying credential:", jqXHR);
                    }
                });
            });
        });
    </script>

    <script src="/static/vendor/jquery/jquery.min.js"></script>
    <script src="/static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        // Use the default BlockAcademia server address
        const BLOCKCHAIN_NODE_URL = 'http://127.0.0.1:5001';

        $(function() {
            $('#verify_button').click(function() {
                $('#valid_alert').addClass('d-none');
                $('#invalid_alert').addClass('d-none');

                let payload = {
                    recipient_public_key: $('#recipient_public_key').val(),
                    credential_hash: $('#credential_hash').val()
                };

                $.ajax({
                    url: BLOCKCHAIN_NODE_URL + '/credentials/verify', // Call the server API directly
                    type: 'POST',
                    dataType: 'json',
                    contentType: 'application/json', // IMPORTANT: Server expects JSON
                    data: JSON.stringify(payload),
                    
                    success: function(response) {
                        if (response.is_valid) {
                            $('#issuer_output').text(response.issuer);
                            $('#credential_type_output').text(response.credential_type);
                            $('#issue_date_output').text(response.issue_date);
                            $('#transaction_id_output').text(response.transaction_id);
                            
                            $('#valid_alert').removeClass('d-none');
                        } else {
                            $('#invalid_message').text(response.message);
                            $('#invalid_alert').removeClass('d-none');
                        }
                    },
                    error: function(jqXHR) {
                        let errorMessage = jqXHR.responseJSON && jqXHR.responseJSON.message ? jqXHR.responseJSON.message : jqXHR.statusText;
                        
                        $('#invalid_message').text(`API Error (${jqXHR.status}): ${errorMessage}`);
                        $('#invalid_alert').removeClass('d-none');
                        console.log("Error verifying credential:", jqXHR);
                    }
                });
            });
        });
    </script>
</body>
</html>
