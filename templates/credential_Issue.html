<!doctype html>
<html lang="en">
<!-- Please note that this page and Javascript was developed with the Assistance of Gemini AI model using the repositories shared during class excerise for weeks 3-5 (https://pastebin.com/2f70amw1, https://pastebin.com/2f70amw1, https://pastebin.com/EtzJ8pFk and https://pastebin.com/EpK3xcMK); where the prompts used are as follows:
 1. "I need to build a new client to interface with the web for my project given the following files. I have an existing file can you refactor so that it simulates the results in the test cases" (files included in this prompt were the files from the URLs mentioned above in addition to the Blockchain Project.zip file and Stella's BlockChain class (BlockAcademia.py) as well as the test cases included (Test_blockchain.py and Test_api_endpoints.py))-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Issue Credential | BlockAcademia</title>

    <link rel="stylesheet" href="/static/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/custom.css">
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a href="/" class="navbar-brand">BlockAcademia</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a href="/" class="nav-link">Home</a>
                    </li>
                    <li class="nav-item active">
                        <a href="/issue/credential" class="nav-link">Issue Credential</a>
                    </li>
                    <li class="nav-item">
                        <a href="/verify/credential" class="nav-link">Verify Credential</a>
                    </li>
<!--                     <li class="nav-item">
                        <a href="/configure" class="nav-link">Configure Node</a>
                    </li> -->
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="mt-5">Issue New Credential (Issuer: Ontario Tech)</h1>
            </div>
        </div>
        <hr>
        
        <div class="row">
            <div class="col-lg-12">
                <form id="issue_credential_form">
                    <div class="form-group">
                        <label for="sender_public_key">Issuer Public Key (Ontario Tech)</label>
                        <textarea class="form-control" id="sender_public_key" name="sender_public_key" rows="2" required readonly>{{ issuer_public_key }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="sender_private_key">Issuer Private Key (Secret Key for Signing): DO NOT SHARE ONLY FOR DEMONSTRATION PURPOSES</label>
                        <textarea class="form-control" id="sender_private_key" name="sender_private_key" rows="2" required readonly>{{ issuer_private_key }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="recipient_public_key">Recipient Public Key (Student Wallet)</label>
                        <textarea class="form-control" id="recipient_public_key" name="recipient_public_key" rows="2" required placeholder="Paste the student's hex-encoded public key here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="credential_type">Credential Type (e.g., MITS AI, B.Sc. Computer Science)</label>
                        <input type="text" class="form-control" id="credential_type" name="credential_type" value="MITS AI" required>
                    </div>
                    <div class="form-group">
                        <label for="issue_date">Issue Date</label>
                         <input type="date" class="form-control" id="issue_date" name="issue_date" value="{{ today }}" required>
                    </div> 
                    <button type="button" class="btn btn-success" id="issue_button">Issue & Broadcast Credential</button>
                </form>
                
                <h3 class="mt-5">Issued Credential Data (For Student to Save)</h3>
                <div id="result_container">
                    <div class="alert alert-info d-none" role="alert" id="success_alert">
                        <strong>Credential Issued!</strong> The student should save the following data for verification:
                        <br>
                        <strong>Credential Hash (SHA256):</strong> <code id="credential_hash" style="word-break: break-all;"></code>
                        <br>
                        <strong>Digital Signature (The proof of issuance):</strong> <code id="signature" style="word-break: break-all;"></code>
                        <br>
                        <strong>Recipient Key:</strong> <code id="recipient_key" style="word-break: break-all;"></code>
                    </div>
                    <div class="alert alert-danger d-none" role="alert" id="error_alert">
                        <strong>Error:</strong> <span id="error_message"></span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="/static/vendor/jquery/jquery.min.js"></script>
    <script src="/static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- Javascript used to Issue Academic Credential from the Issuer Back End [in our Example OntarioTech] which will use the requestors public key to issue their credential which will be signed by the Instituitions private key and the resulting signature and hash will be provided to the requestor for use for future verification. Once issued the issuer sends the credential to the blockchain to be mined in the future; only then will the requestor be able to validate their credential. -->
    <script>
        $(function() {
            $('#issue_button').click(function() {
                // Hide previous alerts
                $('#success_alert').addClass('d-none');
                $('#error_alert').addClass('d-none');
                
                // Collect all required form values
                let senderPublicKey = $('#sender_public_key').val();
                let senderPrivateKey = $('#sender_private_key').val();
                let recipientKey = $('#recipient_public_key').val();
                let type = $('#credential_type').val();
                let date = $('#issue_date').val();

                // Build JSON payload
                let payload = {
                    sender_public_key: senderPublicKey,
                    sender_private_key: senderPrivateKey,
                    recipient_public_key: recipientKey,
                    credential_type: type,
                    issue_date: date
                };

                // Javascript used to send AJAX POST request to issue credential through API on the frontend (client)
                $.ajax({
                    url: '/api/issue/credential',
                    type: 'POST',
                    contentType: 'application/json',
                    dataType: 'json',
                    data: JSON.stringify(payload),
                    // If successful. The credential hashes are displayed for the user to use in order to verify their credential in the future (user is instructed to copy for future use.)
                    success: function(response) {
                        $('#credential_hash').text(response.credential_data.credential_hash);
                        $('#signature').text(response.signature);
                        $('#recipient_key').text(response.credential_data.recipient_public_key);

                        $('#success_alert').removeClass('d-none');//Hides any previously displayed success messages by adding the d-none class (Bootstrap's display:none utility).
                    },
                    //If the API call fails a error message will be displayed and a log event created
                    error: function(jqXHR, textStatus, errorThrown) {
                        let errorMessage = jqXHR.responseJSON && jqXHR.responseJSON.message 
                            ? jqXHR.responseJSON.message 
                            : textStatus + ': ' + errorThrown;
                        
                        $('#error_message').text(errorMessage);
                        $('#error_alert').removeClass('d-none'); //Hides any previously displayed error messages by adding the d-none class
                        console.log("Error issuing credential:", jqXHR);
                    }
                });
            });
        });
    </script>
</body>
</html>
